<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./w3.css">
  <title>Wochenplan</title>
  <style>
    body { margin: 0; font-family: "Segoe UI", Roboto, Arial, sans-serif; }
    .container { max-width: 900px; margin: 20px auto; padding: 12px; box-sizing: border-box; }

    .carousel { position: relative; overflow: hidden; border-radius:8px; touch-action: pan-y; }
    .slides { display:flex; transition: transform 300ms ease; will-change: transform; z-index: 0; }
    .slide { min-width:100%; flex: 0 0 100%; padding:16px; box-sizing:border-box; background:#fff; border:1px solid #e6e6e6; }
    .week-title { font-weight:600; margin-bottom:8px; }
    .recipe-list { list-style:none; padding:0; margin:0; }
    .recipe-list li { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; }
    .recipe-list li a { text-decoration:none; color:#111; flex:1; }
    .recipe-thumb { width:60px; height:45px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }

    /* Local-only recipe highlight */
    .local-only { background-color: #fff8d5; } /* pale yellow */

    .arrow {
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:rgba(0,0,0,0.45);
      color:#fff;
      border-radius:50%;
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      opacity:0;
      transition:opacity 150ms;
      z-index: 10;
      pointer-events:auto;
      border: none;
    }
    .carousel:hover .arrow { opacity:1; }

    .arrow.left { left:8px; }
    .arrow.right { right:8px; }

    @media (hover: none) {
      .arrow { display: none !important; }
    }

    .remove-btn { background:#e74c3c; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }

    .controls { display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .sync-form { display:flex; gap:8px; align-items:center; margin-left:auto; }
    .sync-form input { max-width:180px; width:100%; box-sizing:border-box; padding:6px 8px; }
    .sync-form button { white-space:nowrap; }

    @media (max-width:600px) {
      .container { margin: 0; padding: 10px; max-width: 100%; }
      html, body { overflow-x: hidden; }
      .recipe-thumb { width:48px; height:36px; }
    }

    .arrow:focus { outline: 3px solid rgba(255,255,255,0.25); }
  </style>
</head>
<body class="w3-light-grey">
  <div class="w3-bar w3-teal">
    <a href="index.html" class="w3-bar-item w3-button">Home</a>
    <a href="edit_recipes.html" class="w3-bar-item w3-button">Editor</a>
  </div>

  <div class="container">
    <h1>Wochenplan</h1>

    <div class="carousel" id="carousel" aria-roledescription="carousel">
      <button class="arrow left" id="arrowLeft" aria-label="Vorherige Woche">◀</button>
      <button class="arrow right" id="arrowRight" aria-label="Nächste Woche">▶</button>
      <div class="slides" id="slides" role="list"></div>
    </div>

    <div class="controls">
      <div class="sync-form" aria-hidden="false">
        <input id="githubToken" type="password" placeholder="GitHub Token (optional)">
        <button id="syncBtn" class="w3-button w3-blue">Sync</button>
        <span id="syncStatus" style="margin-left:8px;color:#666;font-size:0.95rem;"></span>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const WEEKPLAN_KEY = 'weekPlan_v1';
    const repoOwner = 'Olimaol';
    const repoName = 'rezepte';
    const weekPlanPath = 'recipes/weekplan.json';
    const githubRawBase = (owner, repo, branch, path) => `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;

    function loadPlanLocal(){ try{ return JSON.parse(localStorage.getItem(WEEKPLAN_KEY) || '{}'); }catch(e){ return {}; } }
    function savePlanLocal(p){ localStorage.setItem(WEEKPLAN_KEY, JSON.stringify(p)); }

    function isoWeekKey(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }

    function getWeekOffsets() { return [ -2, -1, 0 ]; }

    async function fetchWeekPlanFromGitHub() {
      const branches = ['main','master'];
      for (const b of branches) {
        try {
          const url = githubRawBase(repoOwner, repoName, b, weekPlanPath);
          const res = await fetch(url);
          if (!res.ok) continue;
          return await res.json();
        } catch (e) { continue; }
      }
      return null;
    }

    function mergePlans(localPlan, remotePlan) {
      const merged = {};
      const localOnlyFlags = {};

      const allWeeks = new Set([...Object.keys(remotePlan || {}), ...Object.keys(localPlan || {})]);

      allWeeks.forEach(week => {
        merged[week] = [];
        localOnlyFlags[week] = [];

        const remoteRecipes = (remotePlan && remotePlan[week]) ? [...remotePlan[week]] : [];
        const localRecipes = (localPlan && localPlan[week]) ? [...localPlan[week]] : [];

        // add all remote recipes first
        remoteRecipes.forEach(r => {
          merged[week].push(r);
          localOnlyFlags[week].push(false);
        });

        // add local-only recipes
        const remoteIndexes = new Set(remoteRecipes.map(r => r.index));
        localRecipes.forEach(r => {
          if (!remoteIndexes.has(r.index)) {
            merged[week].push(r);
            localOnlyFlags[week].push(true); // mark as local only
          }
        });
      });

      return { merged, localOnlyFlags };
    }

    function buildSlidesFromPlan(plan, localOnlyFlags) {
      const slides = document.getElementById('slides');
      slides.innerHTML = '';
      const offsets = getWeekOffsets();
      offsets.forEach(off => {
        const d = new Date(); d.setDate(d.getDate() + off*7);
        const key = isoWeekKey(d);
        const slide = document.createElement('div'); 
        slide.className = 'slide';
        const h = document.createElement('div'); 
        h.className = 'week-title'; 
        h.textContent = key; 
        slide.appendChild(h);

        const list = document.createElement('ul'); 
        list.className = 'recipe-list';
        (plan[key] || []).forEach((r, idx) => {
          const li = document.createElement('li'); 
          li.setAttribute('role','listitem');
          if (localOnlyFlags && localOnlyFlags[key] && localOnlyFlags[key][idx]) {
            li.classList.add('local-only');
          }
          const img = document.createElement('img'); 
          img.src = r.image || ''; 
          img.className = 'recipe-thumb'; 
          img.alt = r.title || '';
          const a = document.createElement('a'); 
          a.href = r.url || '#'; 
          a.textContent = r.title || '(kein Titel)';
          const remove = document.createElement('button'); 
          remove.className = 'remove-btn'; 
          remove.textContent = 'Entfernen';
          remove.onclick = ()=>{ 
            plan[key].splice(idx,1); 
            savePlanLocal(plan); 
            buildSlidesFromPlan(plan, localOnlyFlags); 
            centerToCurrent(); 
          };
          li.appendChild(img); li.appendChild(a); li.appendChild(remove); 
          list.appendChild(li);
        });

        if (!(plan[key] && plan[key].length)) {
          const empty = document.createElement('p'); 
          empty.textContent = 'Keine Rezepte für diese Woche.'; 
          slide.appendChild(empty);
        } else {
          slide.appendChild(list);
        }
        slides.appendChild(slide);
      });

      current = offsets.length - 1;
      updateArrows();
      requestAnimationFrame(() => centerToCurrent());
    }

    async function init(){
      const local = loadPlanLocal();
      buildSlidesFromPlan(local, {});

      try {
        const remote = await fetchWeekPlanFromGitHub();
        if (remote) {
          const { merged, localOnlyFlags } = mergePlans(local, remote);
          savePlanLocal(merged);
          buildSlidesFromPlan(merged, localOnlyFlags);
          document.getElementById('syncStatus').textContent = 'Daten geladen (inkl. lokale Änderungen)';
        } else {
          document.getElementById('syncStatus').textContent = 'Keine remote Daten gefunden; nur lokale angezeigt';
        }
      } catch (e) {
        console.warn('Remote load failed', e);
      }

      setTimeout(()=>{ centerToCurrent(); }, 80);
    }

    async function syncToGitHub(){
      const token = document.getElementById('githubToken').value.trim();
      if(!token){ document.getElementById('syncStatus').textContent = 'Kein Token angegeben (localStorage bleibt)'; return; }
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${weekPlanPath}`;
      try{
        let sha = null;
        const getRes = await fetch(apiUrl);
        if(getRes.ok){ const fileData = await getRes.json(); sha = fileData.sha; }
        const contentObj = loadPlanLocal();
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(contentObj,null,2))));
        const putRes = await fetch(apiUrl, {
          method:'PUT',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'token '+token
          },
          body: JSON.stringify({ message:'Update weekplan', content: content, sha: sha })
        });
        if(putRes.ok){
          document.getElementById('syncStatus').textContent = 'Sync erfolgreich (remote gespeichert)';
        } else {
          const err = await putRes.json();
          console.error(err);
          document.getElementById('syncStatus').textContent = 'Sync fehlgeschlagen (siehe Konsole)';
        }
      }catch(e){
        console.error(e);
        document.getElementById('syncStatus').textContent = 'Sync error (siehe Konsole)';
      }
    }

    document.getElementById('syncBtn').addEventListener('click', syncToGitHub);

    const carouselEl = document.getElementById('carousel');
    const slidesEl = document.getElementById('slides');
    let current = 0;

    function slideWidth(){
      return carouselEl.clientWidth || carouselEl.getBoundingClientRect().width || window.innerWidth;
    }
    function showCurrent(){
      const w = slideWidth();
      slidesEl.style.transform = `translateX(${ -current * w }px)`;
      updateArrows();
    }
    function updateArrows(){
      const left = document.getElementById('arrowLeft');
      const right = document.getElementById('arrowRight');
      left.style.opacity = (current > 0) ? '1' : '0.35';
      right.style.opacity = (current < slidesEl.children.length - 1) ? '1' : '0.35';
      left.disabled = (current <= 0);
      right.disabled = (current >= slidesEl.children.length - 1);
    }
    function centerToCurrent(){
      if(current >= slidesEl.children.length) current = slidesEl.children.length -1;
      if(current < 0) current = 0;
      showCurrent();
    }

    window.addEventListener('resize', ()=>{ showCurrent(); });
    document.getElementById('arrowLeft').addEventListener('click', ()=>{ if(current>0) current--; showCurrent(); });
    document.getElementById('arrowRight').addEventListener('click', ()=>{ if(current < slidesEl.children.length-1) current++; showCurrent(); });

    window.addEventListener('storage', ()=>{ const p = loadPlanLocal(); buildSlidesFromPlan(p, {}); });

    init();
  })();
  </script>
</body>
</html>
